#@TYPE: Machine
#@NAME: XCORE 7358CI
#@DESCRIPTION: Machine configuration for the XCORE 7358CI

SOC_FAMILY = "bcm7358"
require conf/machine/include/soc-family.inc

PREFERRED_VERSION_linux-xcore = "4.0.2"
PREFERRED_VERSION_linux-libc-headers = "4.0"

require conf/machine/include/xcore-mipsel.inc

MACHINE_FEATURES += "ci textlcd videoenhancement blindscan-dvbs singlecore feature1 feature2 7segment"

IMAGE_FSTYPES ?= "ubi"

UBI_VOLNAME = "rootfs"
MKUBIFS_ARGS = "-m 2048 -e 126976 -c 4096"
UBINIZE_ARGS = "-m 2048 -p 128KiB"

IMAGE_CMD_ubi_prepend = " \
    rm -rf ${IMAGE_ROOTFS}/boot/*; \
    rm -rf ${IMAGE_ROOTFS}/tmp/*; \
    "

IMAGE_CMD_ubi_append = "\
    mkdir -p ${DEPLOY_DIR_IMAGE}/${IMAGEDIR}; \
    cp ${DEPLOY_DIR_IMAGE}/splash.bin ${DEPLOY_DIR_IMAGE}/${IMAGEDIR}/splash.bin; \
    mv ${IMGDEPLOYDIR}/${IMAGE_NAME}.rootfs.ubi ${DEPLOY_DIR_IMAGE}/${IMAGEDIR}/${ROOTFS_FILE}; \
    cp ${DEPLOY_DIR_IMAGE}/${KERNEL_IMAGETYPE}-${MACHINE}.bin ${DEPLOY_DIR_IMAGE}/${IMAGEDIR}/${KERNEL_FILE}; \
    FILESIZE=$(stat -c%s "${DEPLOY_DIR_IMAGE}/${IMAGEDIR}/${ROOTFS_FILE}"); \
    echo ${DISTRO_NAME}-${IMAGE_VERSION}-${MACHINE}-${DATE}_usb > ${DEPLOY_DIR_IMAGE}/${IMAGEDIR}/imageversion; \
    echo "#" > ${DEPLOY_DIR_IMAGE}/sysinit.txt; \
    echo "# DO NOT EDIT THIS FILE" >> ${DEPLOY_DIR_IMAGE}/sysinit.txt; \
    echo "#" >> ${DEPLOY_DIR_IMAGE}/sysinit.txt; \
    echo "flash -noheader -forceerase usbdisk0:${IMAGEDIR}/${KERNEL_FILE} nandflash0.kernel" >> ${DEPLOY_DIR_IMAGE}/sysinit.txt; \
    echo "&& flash -noheader -forceerase -size=${FILESIZE} usbdisk0:${IMAGEDIR}/${ROOTFS_FILE} nandflash0.rootfs" >> ${DEPLOY_DIR_IMAGE}/sysinit.txt; \
    echo "&& flash -noheader -forceerase usbdisk0:${IMAGEDIR}/splash.bin nandflash0.splash" >> ${DEPLOY_DIR_IMAGE}/sysinit.txt; \
    echo "&& setenv -p STARTUP \"boot -z -elf nandflash0.kernel: 'ubi.mtd=rootfs root=ubi0:rootfs rootfstype=ubifs console=ttyS0,115200'\"" >> ${DEPLOY_DIR_IMAGE}/sysinit.txt; \
    echo "# for one Flash Box Change setenv" >> ${DEPLOY_DIR_IMAGE}/sysinit.txt; \
    echo "#&& setenv -p STARTUP \"boot -z -elf flash0.kernel: 'ubi.mtd=rootfs root=ubi0:rootfs rootfstype=ubifs console=ttyS0,115200'\"" >> ${DEPLOY_DIR_IMAGE}/sysinit.txt; \
    cd ${DEPLOY_DIR_IMAGE}; \
    zip ${IMAGE_NAME}_usb.zip ${IMAGEDIR}/*; \
    zip ${IMAGE_NAME}_usb.zip sysinit.txt; \
    rm -f ${DEPLOY_DIR_IMAGE}/*.ubi; \
    rm -f ${DEPLOY_DIR_IMAGE}/*.ubifs; \
    rm -f ${DEPLOY_DIR_IMAGE}/*.manifest; \
    rm -f ${DEPLOY_DIR_IMAGE}/.ubifs; \
    rm -f ${DEPLOY_DIR_IMAGE}/.manifest; \
    rm -rf ${IMAGEDIR}; \
    "
